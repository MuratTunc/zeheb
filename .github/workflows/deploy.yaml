name: Deploy Backend and Frontend to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        continue-on-error: false  # Ensure this step fails the job if it fails
        id: checkout

      - name: Set up SSH key
        run: |
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}

      - name: Add GitHub to known hosts
        run: ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Start SSH agent
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_KEY }}" | ssh-add -
      
      - name: Clone Repository to Server
        run: |
          SERVER_IP="${{ secrets.SERVER_IP }}"
          SERVER_USER_NAME="${{ secrets.SERVER_USER_NAME }}"
          SERVER_PROJECT_DIR="${{ secrets.SERVER_PROJECT_DIR }}"
          REPO="${{ secrets.REPO }}"

          echo "Cloning repository to the server..."
          ssh -T -o StrictHostKeyChecking=no $SERVER_USER_NAME@$SERVER_IP << EOF
            set -e  # Stop script on error
            
              # Start SSH agent if not already running
              eval \$(ssh-agent -s)

              # Add private key to SSH agent
              ssh-add ~/.ssh/id_rsa

              # Ensure GitHub is in known hosts
              mkdir -p ~/.ssh
              ssh-keyscan github.com >> ~/.ssh/known_hosts

            # Check if the project directory exists, if not, create it and clone the repository
            if [ ! -d "$SERVER_PROJECT_DIR" ]; then
              echo "Creating project directory..."
              mkdir -p "$SERVER_PROJECT_DIR"
              echo "Directory does not exist. Cloning repository..."
              git clone git@github.com:MuratTunc/zeheb.git /home/mutu/zeheb
            else
              echo "Directory exists. Pulling latest changes..."
              cd $SERVER_PROJECT_DIR
              git reset --hard
              git pull origin main
            fi
          EOF

      - name: Upload .env file to the server
        run: |
            SERVER_USER_NAME="${{ secrets.SERVER_USER_NAME }}"
            SERVER_IP="${{ secrets.SERVER_IP }}"
            SERVER_PROJECT_DIR="${{ secrets.SERVER_PROJECT_DIR }}"
            echo "Uploading .env file to the server..."
            scp back-end/build-tools/.env $SERVER_USER_NAME@$SERVER_IP:$SERVER_PROJECT_DIR/back-end/build-tools/    

      - name: Deploy Back-End Services
        if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'Merge branch back-end-dev')
        run: |
          SERVER_IP="${{ secrets.SERVER_IP }}"
          SERVER_USER_NAME="${{ secrets.SERVER_USER_NAME }}"
          SERVER_PROJECT_DIR="${{ secrets.SERVER_PROJECT_DIR }}"

          echo "Deploying back-end services..."
          ssh -T -o StrictHostKeyChecking=no $SERVER_USER_NAME@$SERVER_IP << EOF
            set -e  # Stop script on error

            # Navigate to the build-tools directory
            cd $SERVER_PROJECT_DIR/back-end/build-tools
            echo "Running 'make down' and 'make up_build'..."
            sudo make down || { echo "'make down' failed!"; exit 1; }
            sudo make up_build || { echo "'make up_build' failed!"; exit 1; }
          EOF

      - name: Deploy Front-End
        if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'Merge branch web-app-dev')
        run: |
          SERVER_IP="${{ secrets.SERVER_IP }}"
          SERVER_USER_NAME="${{ secrets.SERVER_USER_NAME }}"
          SERVER_PROJECT_DIR="${{ secrets.SERVER_PROJECT_DIR }}"

          echo "Deploying front-end..."
          ssh -T -o StrictHostKeyChecking=no $SERVER_USER_NAME@$SERVER_IP << EOF
            set -e  # Stop script on error

            # Navigate to the web-app directory
            cd $SERVER_PROJECT_DIR/web-app
            echo "Installing front-end dependencies..."
            npm install || { echo "npm install failed!"; exit 1; }

            echo "Building front-end..."
            npm run build || { echo "npm build failed!"; exit 1; }

            echo "Copying front-end build files to Nginx web root..."
            sudo rm -rf /var/www/html/*  # Clean existing files
            sudo cp -r $SERVER_PROJECT_DIR/web-app/build/* /var/www/html/

            echo "Front-end deployed successfully!"
          EOF
